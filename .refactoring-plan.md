# CSS Refactoring Plan

## Current State

### ESM Compliance ✅
- **package.json**: `"type": "module"` - Strict ESM enabled
- **tsconfig.json**: `"module": "ESNext"`, `"moduleResolution": "bundler"`
- **Source files**: All using ES6 `import/export`, no CommonJS detected
- **Status**: **COMPLIANT** - No changes needed

### Large Files Requiring Refactoring

#### `public/css/features/game.css` - **1221 lines** ⚠️

**Current structure** (monolithic):
- Lines 3-87: HUD styles
- Lines 88-251: Character slots, grids, SVG
- Lines 224-295: Text displays, footer progress
- Lines 296-474: Feedback, modals, effects
- Lines 475-636: Animation keyframes
- Lines 637-688: Toolbars & buttons
- Lines 689-976: Dictation/spelling modes
- Lines 822+: Responsive (@media queries)

## Proposed Modular Structure

### Phase 1: Extract Core Components (Low Risk)
Split into focused modules using CSS `@import`:

```
public/css/features/
├── game/
│   ├── _hud.css              (~85 lines)
│   ├── _characters.css       (~160 lines)
│   ├── _displays.css         (~70 lines)
│   ├── _feedback.css         (~180 lines)
│   ├── _animations.css       (~160 lines)
│   ├── _toolbars.css         (~50 lines)
│   ├── _dictation.css        (~290 lines)
│   └── _responsive.css       (~220 lines)
└── game.css                  (~6 lines - imports only)
```

**New game.css** (main orchestrator):
```css
/* Game Feature Styles - Modular Architecture */
@import url('./_hud.css');
@import url('./_characters.css');
@import url('./_displays.css');
@import url('./_feedback.css');
@import url('./_animations.css');
@import url('./_toolbars.css');
@import url('./_dictation.css');
@import url('./_responsive.css');
```

### Phase 2: Optimization (Medium Risk)
After modular split is stable:
1. Remove duplicate responsive rules
2. Consolidate similar animations
3. Extract CSS variables to `:root`
4. Minify for production

## Benefits

### Maintainability
- **Single Responsibility**: Each file has one purpose
- **Easier Navigation**: Jump to relevant file instead of scrolling
- **Parallel Development**: Multiple devs can work on different files

### Performance
- **Browser Caching**: Individual files cache independently
- **Lazy Loading**: Could load modules on-demand in future
- **Build Optimization**: Vite can tree-shake unused styles

### Stability
- **Incremental Changes**: Refactor one module at a time
- **Easy Rollback**: Git history shows which module changed
- **Testing**: Can test each module in isolation

## Execution Strategy

### Pre-Flight Checklist
- [ ] Create feature branch: `refactor/modular-css`
- [ ] Backup current `game.css`
- [ ] Run visual regression tests (screenshot comparison)
- [ ] Document all CSS classes and their usage

### Step-by-Step (Each Step = 1 PR)

**PR 1: Setup Infrastructure**
- Create `public/css/features/game/` directory
- Add `.gitkeep` and README

**PR 2: Extract _hud.css**
- Extract HUD-related styles (lines 3-87)
- Update `game.css` with `@import`
- **Test**: Verify HUD renders correctly
- **Rollback Plan**: Revert single PR

**PR 3: Extract _characters.css**
- Extract character/grid styles (lines 88-251)
- Update imports
- **Test**: Verify char-slot, grids work
- **Rollback Plan**: Revert single PR

**PR 4-8: Continue incrementally...**
- One module per PR
- Full test suite after each
- Screenshot comparison

**PR 9: Responsive Consolidation**
- Extract all `@media` queries last
- Consolidate duplicate rules
- **Test**: Test on all breakpoints

### Testing Strategy

**Automated**
```bash
# Visual regression
npm run test:visual

# Build verification
npm run build && npm run preview

# Lighthouse CI
npm run lighthouse
```

**Manual**
- [ ] Desktop (Chrome, Firefox, Safari)
- [ ] Mobile (iOS Safari, Chrome Android)
- [ ] Tablet (iPad, Android tablet)
- [ ] All breakpoints (360px, 600px, 1024px)

### Risk Mitigation

**Low Risk Approach**
1. Extract one file at a time
2. Full test after each extraction
3. Keep PRs small (<200 lines changed)
4. Easy rollback with `git revert`

**Regression Prevention**
- Screenshot comparison before/after
- Automated visual diff tools
- User acceptance testing
- Canary deployment (10% → 50% → 100%)

## Alternative: Incremental Approach

If full refactor is too risky, use **progressive enhancement**:

1. Keep `game.css` as-is
2. New features go in modular files
3. Gradually migrate old styles during bug fixes
4. Complete migration over 6 months

## File Size Targets

| File | Current | Target | Status |
|------|---------|--------|--------|
| game.css | 1221 | <100 (imports) | ⚠️ |
| _responsive.css | - | ~220 | - |
| _dictation.css | - | ~290 | - |
| _feedback.css | - | ~180 | - |
| _characters.css | - | ~160 | - |
| _animations.css | - | ~160 | - |
| _hud.css | - | ~85 | - |
| _displays.css | - | ~70 | - |
| _toolbars.css | - | ~50 | - |

## Timeline (Conservative)

- **Week 1**: Setup + Extract HUD (PR 1-2)
- **Week 2**: Extract Characters + Displays (PR 3-4)
- **Week 3**: Extract Animations + Toolbars (PR 5-6)
- **Week 4**: Extract Dictation (PR 7)
- **Week 5**: Extract Responsive (PR 8)
- **Week 6**: Testing + Cleanup (PR 9)
- **Week 7**: Production deployment

## Rollback Plan

If issues arise:
```bash
# Rollback specific PR
git revert <commit-hash>

# Emergency: Full rollback to monolithic
git checkout master -- public/css/features/game.css
```

## Success Criteria

- [ ] All 1221 lines preserved (no loss)
- [ ] Zero visual regressions
- [ ] Build time unchanged (±10%)
- [ ] No console errors
- [ ] All functionality works
- [ ] Mobile UX maintained
- [ ] Lighthouse score maintained

## Notes

- **ESM Compliance**: Already achieved ✅
- **No Breaking Changes**: Guaranteed by incremental approach
- **Stability**: Each PR is independently testable
- **Queue Status**: Ready to execute when approved
